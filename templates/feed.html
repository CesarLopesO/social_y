<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Feed</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <script>
        // Fun칞칚o para curtir um post
        function likePost(postId) {
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/like_post/" + postId, true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    const response = JSON.parse(xhr.responseText);
                    const button = document.getElementById("like-button-" + postId);
                    button.innerHTML = `<div>游녨 ${response.likes}</div><div>${response.liked ? "" : "Curtir"}</div>`;
                }
            };
            xhr.send();
        }

        // Fun칞칚o para comentar em um post
        function commentPost(postId) {
            const comment = document.getElementById("comment-input-" + postId).value;
            const xhr = new XMLHttpRequest();
            xhr.open("POST", "/comment_post/" + postId, true);
            xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    document.getElementById("comments-section-" + postId).innerHTML += xhr.responseText;
                    document.getElementById("comment-input-" + postId).value = "";
                }
            };
            xhr.send("comment=" + encodeURIComponent(comment));
        }
    </script>
</head>
<body>
    <div class="container">
        <h2>Feed</h2>
        <a href="/logout">Logout</a>
        <a href="/profile">Meu Perfil</a>

        <!-- Formul치rio para adicionar um novo post -->
        <form action="/add_post" method="POST" enctype="multipart/form-data">
            <textarea name="content" rows="4" cols="50" placeholder="O que voc칡 est치 pensando?" required></textarea>
            <input type="file" name="file">
            <button type="submit">Postar</button>
        </form>

        <h3>Posts Recentes</h3>
        {% for post in posts %}
            <div class="post">
                <p>
                    {% if post.profile_pic %}
                        <img src="data:image/jpeg;base64,{{ post.profile_pic }}" alt="Foto de Perfil" class="profile-picture">
                    {% endif %}
                    <strong><a href="{{ url_for('view_profile', username=post.username) }}">{{ post.username }}</a></strong>: {{ post.content }}
                </p>

                <!-- Exibir a imagem do post, se houver -->
                {% if post.image %}
                    <img src="data:image/jpeg;base64,{{ post.image }}" alt="Imagem do post" style="max-width: 100%;">
                {% endif %}

                <!-- Bot칚o de Curtir -->
                <button id="like-button-{{ post.id }}" onclick="likePost('{{ post.id }}')" style="text-align: center;">
                    <div>游녨 {{ post.likes }}</div>
                    <div>
                        {% if session['username'] in post.liked_by %}
                            J치 curtiu
                        {% else %}
                            Curtir
                        {% endif %}
                    </div>
                </button>

                <!-- Se칞칚o de Coment치rios -->
                <div id="comments-section-{{ post.id }}" class="comments">
                    {% if post.comments %}
                        <h4>Coment치rios</h4>
                        {% for comment in post.comments %}
                            <p>
                                {% if comment.profile_pic %}
                                    <img src="data:image/jpeg;base64,{{ comment.profile_pic }}" alt="Foto de Perfil" class="profile-picture">
                                {% else %}
                                    <p>Sem foto de perfil</p>
                                {% endif %}
                                <strong><a href="{{ url_for('view_profile', username=comment.username) }}">{{ comment.username }}</a></strong>: {{ comment.content }}
                            </p>
                        {% endfor %}
                    {% endif %}
                </div>

                <!-- Formul치rio de Coment치rio -->
                <textarea id="comment-input-{{ post.id }}" rows="2" cols="50" placeholder="Adicione um coment치rio..." required></textarea>
                <button onclick="commentPost('{{ post.id }}')">Comentar</button>
            </div>
            <hr style="border: 1px solid #ccc; margin: 20px 0;">
        {% endfor %}


    </div>
</body>
</html>
